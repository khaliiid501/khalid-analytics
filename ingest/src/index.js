'use strict';\n\nrequire('dotenv').config();\nconst WebSocket = require('ws');\nconst http = require('http');\nconst { Server } = require('socket.io');\nconst { Pool } = require('pg');\nconst { createClient: createRedisClient } = require('redis');\n\nconst FINNHUB_KEY = process.env.FINNHUB_KEY;\nconst SYMBOLS = (process.env.SYMBOLS || 'AAPL,TSLA').split(',').map(s => s.trim()).filter(Boolean);\nconst PORT = process.env.PORT || 4000;\nconst TIMESCALE_DSN = process.env.TIMESCALE_DSN || '';\nconst REDIS_URL = process.env.REDIS_URL || '';\n\nif (!FINNHUB_KEY) {\n  console.error('ERROR: FINNHUB_KEY is not set in environment');\n  process.exit(1);\n}\n\n// Optional DB pool\nlet pgPool = null;\nif (TIMESCALE_DSN) {\n  pgPool = new Pool({ connectionString: TIMESCALE_DSN });\n  pgPool.on('error', (err) => console.error('Postgres pool error', err));\n}\n\n// Optional Redis\nlet redisClient = null;\nif (REDIS_URL) {\n  redisClient = createRedisClient({ url: REDIS_URL });\n  redisClient.connect().catch(err => console.error('Redis connection error', err));\n}\n\nconst server = http.createServer();\nconst io = new Server(server, { cors: { origin: '*' } });\n\nio.on('connection', (socket) => {\n  console.log('client connected', socket.id);\n});\n\nserver.listen(PORT, () => console.log(`Ingest service listening on port ${PORT}`));\n\n// Finnhub websocket\nconst WS_URL = `wss://ws.finnhub.io?token=${FINNHUB_KEY}`;\nlet backoff = 1000;\nlet ws;\n\nfunction connect() {\n  ws = new WebSocket(WS_URL);\n\n  ws.on('open', () => {\n    console.log('Connected to Finnhub');\n    backoff = 1000;\n    // subscribe to symbols\n    SYMBOLS.forEach(sym => {\n      const msg = JSON.stringify({ type: 'subscribe', symbol: sym });\n      ws.send(msg);\n      console.log('Subscribed to', sym);\n    });\n  });\n\n  ws.on('message', async (raw) => {\n    try {\n      const payload = JSON.parse(raw);\n      if (payload.type === 'trade' && Array.isArray(payload.data)) {\n        for (const tick of payload.data) {\n          const event = {\n            symbol: tick.s,\n            price: tick.p,\n            volume: tick.v,\n            timestamp: new Date(tick.t) // Finnhub returns ms\n          };\n\n          // broadcast to websocket clients\n          io.emit('market:trade', event);\n\n          // optional: write to TimescaleDB\n          if (pgPool) {\n            try {\n              await pgPool.query(\n                'INSERT INTO trades(time, symbol, price, volume) VALUES($1, $2, $3, $4)',\n                [event.timestamp, event.symbol, event.price, event.volume]\n              );\n            } catch (err) {\n              console.error('TimescaleDB insert error', err.message || err);\n            }\n          }\n\n          // optional: publish to Redis stream\n          if (redisClient) {\n            try {\n              await redisClient.xAdd('market:trades', '*', {\n                symbol: event.symbol,\n                price: String(event.price),\n                volume: String(event.volume),\n                time: event.timestamp.toISOString()\n              });\n            } catch (err) {\n              console.error('Redis publish error', err.message || err);\n            }\n          }\n        }\n      }\n    } catch (err) {\n      console.error('Failed to process message', err.message || err);\n    }\n  });\n\n  ws.on('close', (code, reason) => {\n    console.warn('Finnhub websocket closed', code, reason);\n    reconnect();\n  });\n\n  ws.on('error', (err) => {\n    console.error('Finnhub websocket error', err && err.message ? err.message : err);\n    ws.close();\n  });\n}\n\nfunction reconnect() {\n  setTimeout(() => {\n    backoff = Math.min(backoff * 2, 60000);\n    console.log('Reconnecting to Finnhub, backoff', backoff);\n    connect();\n  }, backoff);\n}\n\n// Start\nconnect();\n\n// Graceful shutdown\nprocess.on('SIGINT', async () => {\n  console.log('Shutting down...');\n  try { if (ws) ws.close(); } catch(e){}\n  try { await io.close(); } catch(e){}\n  if (pgPool) await pgPool.end();\n  if (redisClient) await redisClient.disconnect();\n  process.exit(0);\n});